name: CD - Deploy to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        default: ''
  push:
    tags:
      - 'v*.*.*'

# Only one production deployment at a time
concurrency:
  group: deploy-production
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  validate-input:
    name: Validate Deployment Request
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "deploy" ]; then
            echo "âŒ Deployment cancelled: confirmation not provided"
            echo "Please type 'deploy' in the confirmation field"
            exit 1
          fi
          echo "âœ… Deployment confirmed"

  deploy-production:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    needs: [validate-input]
    if: always() && (needs.validate-input.result == 'success' || github.event_name == 'push')
    environment:
      name: production
      url: http://172.104.61.233
    
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      
      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          VITE_ENABLE_DEBUG_MODE: false
      
      - name: Create deployment package
        run: |
          cd dist
          tar -czf ../deploy-production.tar.gz .
          cd ..
          ls -lh deploy-production.tar.gz
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to production server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH_PRODUCTION }}
        run: |
          echo "ðŸš€ Deploying to PRODUCTION environment..."
          
          # Upload deployment package
          scp -i ~/.ssh/deploy_key -P $SSH_PORT deploy-production.tar.gz $SSH_USERNAME@$SSH_HOST:/tmp/
          
          # Execute deployment on server
          ssh -i ~/.ssh/deploy_key -p $SSH_PORT $SSH_USERNAME@$SSH_HOST << 'ENDSSH'
            set -e
            
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH_PRODUCTION }}"
            BACKUP_DIR="/var/www/backups/production"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            echo "ðŸ“¦ Creating backup..."
            mkdir -p "$BACKUP_DIR"
            
            if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH)" ]; then
              tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" -C "$DEPLOY_PATH" . || true
              echo "âœ… Backup created: backup_$TIMESTAMP.tar.gz"
              
              # Keep only last 10 backups for production
              cd "$BACKUP_DIR" && ls -t | tail -n +11 | xargs -r rm
            fi
            
            echo "ðŸ”„ Deploying new version..."
            mkdir -p "$DEPLOY_PATH"
            rm -rf "$DEPLOY_PATH"/*
            tar -xzf /tmp/deploy-production.tar.gz -C "$DEPLOY_PATH"
            
            echo "ðŸ§¹ Cleanup..."
            rm /tmp/deploy-production.tar.gz
            
            echo "âœ… Deployment complete!"
            echo "ðŸ“ Deployed to: $DEPLOY_PATH"
            echo "ðŸŒ URL: http://172.104.61.233"
          ENDSSH
      
      - name: Health check
        run: |
          echo "ðŸ¥ Running health check..."
          sleep 5
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://172.104.61.233 || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health check passed! (HTTP $HTTP_CODE)"
          else
            echo "âŒ Health check failed! (HTTP $HTTP_CODE)"
            echo "âš ï¸ Production deployment may have issues!"
            exit 1
          fi
      
      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
      
      - name: Deployment summary
        if: success()
        run: |
          echo "## ðŸŽ‰ Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** http://172.104.61.233" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Rollback Instructions" >> $GITHUB_STEP_SUMMARY
          echo "If issues occur, SSH to server and run:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "cd /var/www/backups/production" >> $GITHUB_STEP_SUMMARY
          echo "ls -lht  # Find the backup to restore" >> $GITHUB_STEP_SUMMARY
          echo "tar -xzf backup_TIMESTAMP.tar.gz -C /var/www/delta-production" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
