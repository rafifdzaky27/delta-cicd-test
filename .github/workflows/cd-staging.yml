name: CD - Deploy to Staging

on:
  workflow_run:
    workflows: ["CI - Build and Lint"]
    types:
      - completed
    branches: [main, master]
  workflow_dispatch:

# Only one deployment at a time
concurrency:
  group: deploy-staging
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment:
      name: staging
      url: http://172.104.61.233:8081
    
    steps:
      - name: Download production build artifact
        uses: actions/download-artifact@v4
        with:
          name: production-build-${{ github.sha }}
          path: dist/
      
      - name: Verify artifact contents
        run: |
          echo "ðŸ“¦ Verifying downloaded artifact..."
          ls -lah dist/
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Error: index.html not found in artifact!"
            exit 1
          fi
          echo "âœ… Artifact verified successfully"
      
      - name: Create deployment package
        run: |
          cd dist
          tar -czf ../deploy-staging.tar.gz .
          cd ..
          ls -lh deploy-staging.tar.gz
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to staging server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH_STAGING }}
        run: |
          echo "ðŸš€ Deploying to staging environment..."
          
          # Upload deployment package
          scp -i ~/.ssh/deploy_key -P $SSH_PORT deploy-staging.tar.gz $SSH_USERNAME@$SSH_HOST:/tmp/
          
          # Execute deployment on server
          ssh -i ~/.ssh/deploy_key -p $SSH_PORT $SSH_USERNAME@$SSH_HOST << 'ENDSSH'
            set -e
            
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH_STAGING }}"
            BACKUP_DIR="/var/www/backups/staging"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            echo "ðŸ“¦ Creating backup..."
            mkdir -p "$BACKUP_DIR"
            
            if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH)" ]; then
              tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" -C "$DEPLOY_PATH" . || true
              echo "âœ… Backup created: backup_$TIMESTAMP.tar.gz"
              
              # Keep only last 5 backups
              cd "$BACKUP_DIR" && ls -t | tail -n +6 | xargs -r rm
            fi
            
            echo "ðŸ”„ Deploying new version..."
            mkdir -p "$DEPLOY_PATH"
            rm -rf "$DEPLOY_PATH"/*
            tar -xzf /tmp/deploy-staging.tar.gz -C "$DEPLOY_PATH"
            
            echo "ðŸ§¹ Cleanup..."
            rm /tmp/deploy-staging.tar.gz
            
            echo "âœ… Deployment complete!"
            echo "ðŸ“ Deployed to: $DEPLOY_PATH"
            echo "ðŸŒ URL: http://172.104.61.233:8081"
          ENDSSH
      
      - name: Health check
        run: |
          echo "ðŸ¥ Running health check..."
          sleep 5
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://172.104.61.233:8081 || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health check passed! (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Health check returned HTTP $HTTP_CODE"
            echo "Note: This might be expected if the app requires specific routes"
          fi
      
      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
      
      - name: Deployment summary
        if: success()
        run: |
          echo "## ðŸŽ‰ Staging Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** http://172.104.61.233:8081" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ Immutable Artifact" >> $GITHUB_STEP_SUMMARY
          echo "This deployment uses the exact build artifact that passed CI tests." >> $GITHUB_STEP_SUMMARY
          echo "No rebuild occurred - ensuring consistency between test and deployment." >> $GITHUB_STEP_SUMMARY
